<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºæ…§æ´—è¡£æˆ¿æ§åˆ¶å°</title>
  <style>
    :root {
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --secondary: #64748b;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg-gradient: radial-gradient(circle at top right, #1e293b, #0f172a);
      --card-bg: rgba(30, 41, 59, 0.7);
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --border: rgba(255, 255, 255, 0.1);
    }

    [data-theme="light"] {
      --bg-gradient: radial-gradient(circle at top right, #f8fafc, #e2e8f0);
      --card-bg: rgba(255, 255, 255, 0.8);
      --text-main: #1e293b;
      --text-muted: #64748b;
      --border: rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg-gradient);
      color: var(--text-main);
      min-height: 100vh;
      padding: 20px;
      position: relative;
    }

    /* Header Theme Toggle */
    .header-theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-theme-toggle .btn-ghost {
      padding: 8px 16px;
      font-size: 13px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--border);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }

    @media (min-width: 1024px) {
      .container {
        grid-template-columns: 350px 1fr;
        grid-template-rows: auto auto;
        align-items: start;
      }

      /* Left column alignment */
      .card-status,
      .card-controls {
        height: 100%;
        min-height: 400px;
      }

      /* Grid Areas or explicit placement */
      .card-status {
        grid-column: 1;
        grid-row: 1;
      }

      .card-controls {
        grid-column: 1;
        grid-row: 2;
      }

      .card-chart {
        grid-column: 2;
        grid-row: 1;
      }

      .card-logs {
        grid-column: 2;
        grid-row: 2;
      }
    }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      /* margin-bottom removed, handled by grid gap */
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 24px;
      background: linear-gradient(to right, #60a5fa, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
    }

    h2 {
      font-size: 18px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Status Grid */
    .status-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .status-item {
      background: rgba(15, 23, 42, 0.4);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .status-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-value {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-main);
    }

    .status-value.highlight {
      color: var(--primary);
    }

    /* Controls */
    .btn-group-triangular {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .btn-group-triangular .btn-bottom {
      grid-column: 1 / -1;
    }

    .btn-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    button {
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      color: white;
      background: var(--secondary);
    }

    button:hover {
      filter: brightness(110%);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: var(--primary);
    }

    .btn-success {
      background: var(--success);
    }

    .btn-danger {
      background: var(--danger);
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-main);
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    /* Chart */
    .chart-wrapper {
      position: relative;
      height: 300px;
      width: 100%;
    }

    /* Logs */
    .log-box {
      background: #0f172a;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      height: 200px;
      overflow-y: auto;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: #94a3b8;
    }

    .log-entry {
      margin-bottom: 4px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      padding-bottom: 4px;
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-time {
      color: var(--secondary);
      margin-right: 8px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.2);
    }
  </style>
</head>

<body>
  <!-- Header Theme Toggle -->
  <div class="header-theme-toggle">
    <button class="btn-ghost" onclick="toggleTheme()" id="themeToggle">ğŸŒ™ å¤œé—´æ¨¡å¼</button>
  </div>

  <div class="container">
    <!-- Status Card -->
    <div class="card card-status">
      <h1>æ™ºæ…§æ´—è¡£æˆ¿</h1>

      <h2>è®¾å¤‡çŠ¶æ€</h2>
      <div class="status-grid">
        <div class="status-item">
          <div class="status-label">è¿è¡ŒçŠ¶æ€</div>
          <div class="status-value highlight" id="status">--</div>
        </div>
        <div class="status-item">
          <div class="status-label">å½“å‰æ¨¡å¼</div>
          <div class="status-value" id="mode">--</div>
        </div>
        <div class="status-item">
          <div class="status-label">å½“å‰æ¹¿åº¦</div>
          <div class="status-value" id="humidity">--</div>
        </div>
        <div class="status-item">
          <div class="status-label">å½“å‰æ¸©åº¦</div>
          <div class="status-value" id="temperature">--</div>
        </div>
        <div class="status-item" style="grid-column: span 2;">
          <div class="status-label">å‰©ä½™æ—¶é—´</div>
          <div class="status-value" id="countdown">--</div>
        </div>
        <div class="status-item" style="grid-column: span 2;">
          <div class="status-label">æœ€åæ›´æ–°</div>
          <div class="status-value" style="font-size: 14px;" id="updated">--</div>
        </div>
      </div>
    </div>

    <!-- Controls Card -->
    <div class="card card-controls">
      <h2>æ“ä½œæ§åˆ¶</h2>
      <div class="btn-group-triangular">
        <button class="btn-success" onclick="sendCmd('start')">å¯åŠ¨</button>
        <button class="btn-danger" onclick="sendCmd('stop')">åœæ­¢</button>
        <button class="btn-ghost btn-bottom" onclick="sendCmd('toggle')">åˆ‡æ¢</button>
      </div>
      <div style="margin-top: 16px;">
        <div class="status-label" style="margin-bottom: 8px;">æ¨¡å¼è®¾å®š</div>
        <div class="btn-group-triangular">
          <button class="btn-primary" onclick="sendCmd('set_mode', {gear:1})">å¿«é€Ÿ</button>
          <button class="btn-primary" onclick="sendCmd('set_mode', {gear:2})">æ ‡å‡†</button>
          <button class="btn-primary btn-bottom" onclick="sendCmd('set_mode', {gear:3})">æŸ”å’Œ</button>
        </div>
      </div>
    </div>

    <!-- Chart Card -->
    <div class="card card-chart">
      <h2>æ¹¿åº¦ç›‘æ§</h2>
      <div class="chart-wrapper">
        <canvas id="humidityChart"></canvas>
      </div>
    </div>

    <!-- Logs Card -->
    <div class="card card-logs">
      <h2>ç³»ç»Ÿæ—¥å¿—</h2>
      <div class="log-box" id="log"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    // Configuration
    const maxPoints = 50;
    let humidityData = [];
    let timeLabels = [];
    const logBox = document.getElementById('log');

    // Logger
    function log(msg) {
      const time = new Date().toLocaleTimeString();
      const div = document.createElement('div');
      div.className = 'log-entry';
      div.innerHTML = `<span class="log-time">[${time}]</span> ${msg}`;
      logBox.prepend(div);
    }

    // API Interaction
    async function fetchState() {
      try {
        const res = await fetch('/api/state');
        const data = await res.json();
        const payload = data.payload || {};
        const svc = (payload.services && payload.services[0]) || {};
        const p = svc.properties || {};

        // Update UI
        updateText('status', p.status);
        updateText('mode', p.mode);
        updateText('humidity', p.humidity, '%');
        updateText('temperature', p.temperature, 'â„ƒ');
        updateText('countdown', p.countdown);

        const ts = data.ts ? new Date(data.ts * 1000).toLocaleTimeString() : '--';
        document.getElementById('updated').textContent = ts;

        // Update Chart
        if (typeof p.humidity === 'number') {
          const chartTime = data.ts ? new Date(data.ts * 1000).toLocaleTimeString() : new Date().toLocaleTimeString();
          updateChartData(p.humidity, chartTime);
        }
      } catch (e) {
        // Silent fail or minimal log to avoid spam
        console.error('Fetch error:', e);
      }
    }

    function updateText(id, val, suffix = '') {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = (val !== undefined && val !== null) ? val + suffix : '--';
      }
    }

    async function sendCmd(command_name, paras = {}) {
      try {
        const res = await fetch('/api/command', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command_name, paras })
        });
        if (!res.ok) throw new Error(await res.text());
        log(`å‘é€å‘½ä»¤æˆåŠŸ: ${command_name} ${JSON.stringify(paras)}`);
      } catch (e) {
        log(`å‘é€å‘½ä»¤å¤±è´¥: ${e.message}`);
      }
    }

    // Chart Setup
    const ctx = document.getElementById('humidityChart').getContext('2d');
    let chart;

    function initChart() {
      Chart.defaults.color = '#94a3b8';
      Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: timeLabels,
          datasets: [{
            label: 'æ¹¿åº¦ (%)',
            data: humidityData,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 2,
            tension: 0.4,
            fill: true,
            pointRadius: 0,
            pointHitRadius: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(15, 23, 42, 0.9)',
              titleColor: '#f1f5f9',
              bodyColor: '#cbd5e1',
              borderColor: 'rgba(255,255,255,0.1)',
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              suggestedMax: 100,
              grid: { color: 'rgba(255, 255, 255, 0.05)' }
            },
            x: {
              grid: { display: false },
              ticks: { maxTicksLimit: 8 }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });
    }

    function updateChartData(val, time) {
      humidityData.push(val);
      timeLabels.push(time);

      if (humidityData.length > maxPoints) {
        humidityData.shift();
        timeLabels.shift();
      }

      if (chart) {
        chart.update('none'); // 'none' mode for performance
      }
    }

    // Theme Toggle
    function toggleTheme() {
      const html = document.documentElement;
      const button = document.getElementById('themeToggle');

      if (html.getAttribute('data-theme') === 'light') {
        html.removeAttribute('data-theme');
        button.innerHTML = 'ğŸŒ™ å¤œé—´æ¨¡å¼';
        localStorage.setItem('theme', 'dark');
        log('åˆ‡æ¢åˆ°å¤œé—´æ¨¡å¼');
      } else {
        html.setAttribute('data-theme', 'light');
        button.innerHTML = 'â˜€ï¸ ç™½å¤©æ¨¡å¼';
        localStorage.setItem('theme', 'light');
        log('åˆ‡æ¢åˆ°ç™½å¤©æ¨¡å¼');
      }
    }

    // Load saved theme
    function loadTheme() {
      const savedTheme = localStorage.getItem('theme');
      const button = document.getElementById('themeToggle');

      if (savedTheme === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
        button.innerHTML = 'â˜€ï¸ ç™½å¤©æ¨¡å¼';
      } else {
        button.innerHTML = 'ğŸŒ™ å¤œé—´æ¨¡å¼';
      }
    }

    // Initialization
    initChart();
    loadTheme();
    setInterval(fetchState, 3000);
    fetchState();
    log('ç³»ç»Ÿå·²å°±ç»ª');
  </script>
</body>

</html>